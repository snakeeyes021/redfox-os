#!/usr/bin/bash
set -euo pipefail

APP_NAME="SoundThread"
INSTALL_DIR="$HOME/.local/share/$APP_NAME"
DESKTOP_FILE="$HOME/.local/share/applications/$APP_NAME.desktop"
REPO="jphiggins/SoundThread"

echo "Checking for updates for $APP_NAME..."

# Get the latest release data from GitHub API
LATEST_RELEASE=$(curl -s "https://api.github.com/repos/$REPO/releases/latest")
TAG_NAME=$(echo "$LATEST_RELEASE" | grep -oP '"tag_name": "\K(.*)(?=")')

if [ -z "$TAG_NAME" ]; then
    echo "Error: Could not fetch latest release version."
    exit 1
fi

echo "Latest version: $TAG_NAME"

# Construct download URL (assuming standard naming convention based on user input)
# Pattern: SoundThread_v1.0.1-beta_linux_x86_64.tar.gz
# We need to construct the filename dynamically or parse the assets.
# Parsing assets is safer.

DOWNLOAD_URL=$(echo "$LATEST_RELEASE" | grep -oP '"browser_download_url": "\K(.*linux_x86_64.tar.gz)(?=")')

if [ -z "$DOWNLOAD_URL" ]; then
    echo "Error: Could not find a compatible linux_x86_64 download asset."
    exit 1
fi

echo "Downloading from: $DOWNLOAD_URL"

# Create temp dir
TEMP_DIR=$(mktemp -d)
trap 'rm -rf "$TEMP_DIR"' EXIT

# Download
curl -L -o "$TEMP_DIR/soundthread.tar.gz" "$DOWNLOAD_URL"

# Prepare Install Dir
mkdir -p "$INSTALL_DIR"

# Extract
# The archive usually contains a folder, strip it.
tar -xzf "$TEMP_DIR/soundthread.tar.gz" -C "$INSTALL_DIR" --strip-components=1

# Create Desktop Entry
echo "Creating desktop entry..."
mkdir -p "$(dirname "$DESKTOP_FILE")"

cat > "$DESKTOP_FILE" <<EOF
[Desktop Entry]
Name=SoundThread
Comment=GUI for CDP
Exec=$INSTALL_DIR/SoundThread
Icon=$INSTALL_DIR/SoundThread.png
Terminal=false
Type=Application
Categories=Audio;AudioVideo;
EOF

# Make executable just in case
chmod +x "$INSTALL_DIR/SoundThread"

echo "$APP_NAME updated to $TAG_NAME successfully."
